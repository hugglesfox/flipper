on: [push]

jobs:
  build_matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: ["rpi", "linux"]
    steps:
      - name: Install splashkit dependencies
        run: | 
          sudo apt-get update
          sudo apt-get install -y cmake libbz2-dev libcurl4-openssl-dev libflac-dev libfreetype6-dev libmikmod-dev libncurses-dev libpng-dev libsdl2-dev libsdl2-gfx-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-net-dev libsdl2-ttf-dev libvorbis-dev libwebp-dev

      - name: Install splashkit
        run: |
          curl -s https://raw.githubusercontent.com/splashkit/skm/master/install-scripts/skm-install.sh | bash
          ~/.splashkit/skm linux install
          ~/.splashkit/skm global install

      - name: Checkout splashkit
        uses: actions/checkout@v4
        with:
          path: splashkit

      - name: Clone flipper repo
        uses: actions/checkout@v4
        with:
          path: flipper

      - name: Install g++ arm
        run: sudo apt-get install -y gcc-arm-linux-gnueabihf

      - name: Install dotnet
        run: sudo apt-get install -y dotnet-host

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Run flipper
        run: |
          mkdir -p build
          cd build
          python flipper/flipper.py --path flipper ${{ matrix.arch == 'rpi' && '--cs-runtime linux-arm --cpp-prefix arm-linux-gnueabihf-' }}
